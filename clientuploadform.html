<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure File Upload</title>
<style>
  /* Outer page container */
  .page-container {
    border: 0;
    border-radius: 12px;
    padding: 2rem;
    max-width: 1200px;
    width: 90%;
    margin: 3rem auto;
    background-color: var(--bs-black);
    color: var(--bs-info);
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
  }

  /* Greeting */
  #greeting {
    margin-bottom: 2rem;
  }
  #greeting span:first-child {
    font-weight: bold;
    font-size: 1.8rem;
    display: block;
    margin-bottom: 0.2rem;
  }
  #greeting span:last-child {
    font-size: 1rem;
    display: block;
    margin-top: 0.2rem;
    color: var(--bs-info);
  }

  /* Inner upload section */
  .upload-section {
    border: 2px solid var(--bs-info);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    background-color: var(--bs-black);
    width: 100%;
    box-sizing: border-box;
  }

  /* File items */
  .file-item { 
    margin-bottom: 1.8rem; 
    padding: 1rem; 
    background-color: var(--bs-black);
    border-radius: 8px;
    box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
    transition: transform 0.2s ease;
  }
  .file-item:hover { transform: translateY(-2px); }
  .file-item label { font-weight: bold; display: block; margin-bottom: 0.3rem; }
  .note-label { margin-top: 0.5rem; display: block; font-style: italic; color: var(--bs-info); }

  /* File input styling */
  input[type="file"] {
    background-color: var(--bs-black);
    color: var(--bs-info);
    border: 1px solid var(--bs-info);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
  }
  input[type="file"]:hover,
  input[type="file"]:focus {
    background-color: rgba(255,255,255,0.05);
    outline: none;
  }
  input[type="file"]::file-selector-button {
    background-color: var(--bs-black);
    color: var(--bs-info);
    border: 1px solid var(--bs-info);
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
  }
  input[type="file"]::file-selector-button:hover {
    background-color: rgba(255,255,255,0.05);
  }

  /* Progress bar */
  .progress {
    height: 22px; 
    margin-top: 0.5rem;
    border-radius: 6px;
    background-color: rgba(255,255,255,0.1);
  }
  .progress-bar {
    background-color: var(--bs-info) !important;
    font-weight: bold;
    color: var(--bs-black);
  }

  /* Buttons */
  #uploadBtn, #addFileBtn {
    border-radius: 6px;
    padding: 0.5rem 1.25rem;
    font-weight: bold;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  #uploadBtn:hover, #addFileBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  #uploadBtn:disabled { opacity: 0.6; cursor: not-allowed; }

  .text-center { text-align: center; }

  /* Responsive adjustments */
  @media(max-width:768px){
    .page-container { width: 95%; padding: 1.5rem; }
    .upload-section { padding: 1.5rem; }
  }
  
</style>
</head>
<body class="page-body" style="min-height: 100vh;" data-element="page-bg">
<div class="watermark"></div>
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

<!-- Loader -->
<div id="loadingOverlay" class="d-none">
  <div class="text-center">
    <div class="spinner-border" role="status"></div>
    <p class="mt-4">Uploading files... Please wait...</p>
  </div>
</div>

<!-- Page container -->
<div class="page-container">

  <!-- Greeting -->
  <h3 id="greeting">
    <span>Hi there,</span>
    <span>Please upload up to 3 files. You may add a note for each file.</span>
  </h3>

  <div id="alertsContainer" class="mb-3"></div>

  <!-- Upload section -->
  <div class="upload-section">
    <div id="fileContainer"></div>
    <button id="addFileBtn" class="btn btn-secondary mb-3">Add File</button>
  </div>

  <!-- Upload button -->
  <div class="text-center mt-3">
    <button id="uploadBtn" class="btn btn-primary" disabled>Upload Files</button>
  </div>

</div>

<script src="config.js"></script>

<script>
// Max files
const maxFiles = 3;
let filesArray = [];

const addFileBtn = document.getElementById("addFileBtn");
const fileContainer = document.getElementById("fileContainer");
const uploadBtn = document.getElementById("uploadBtn");
const alertsContainer = document.getElementById("alertsContainer"); // ✅ for persistent alerts

// Greet client
const params = new URLSearchParams(window.location.search);
const firstName = params.get("firstName") || "there";
const lastName  = params.get("lastName") || "";
const email     = params.get("email") || "";

document.getElementById("greeting").innerHTML =
  `<span>Hi ${firstName},</span>
   <span>Please upload up to ${maxFiles} files. You may add a note for each file.</span>`;

// Enable/disable upload button
function updateUploadButton() {
  uploadBtn.disabled = !filesArray.some(f => f.file);
}

// Utility to get file icon for non-images
function getFileIcon(fileName) {
  const ext = fileName.split('.').pop().toLowerCase();
  const icons = {
    pdf: '📄', doc: '📄', docx: '📄', txt: '📝', xls: '📊', xlsx: '📊',
    csv: '📊', ppt: '📈', pptx: '📈', default: '📁'
  };
  return icons[ext] || icons.default;
}

// Add a new file input slot
function addFileInput(fileObj = { file: null, note: "" }) {
  if (filesArray.length >= maxFiles) {
    addFileBtn.style.display = "none";
    return;
  }

  const index = filesArray.length;
  filesArray.push(fileObj);

  const div = document.createElement("div");
  div.className = "file-item d-flex align-items-center justify-content-between";
  div.style.gap = "1rem";

  div.innerHTML = `
    <div style="flex:1;">
      <label>File ${index + 1}</label>
      <input type="file" class="form-control mb-1 file-input" data-index="${index}">
      <label class="note-label">Add a note for this file</label>
      <input type="text" class="form-control file-note" data-index="${index}">
      <div class="progress mt-1">
        <div class="progress-bar" style="width:0%">Waiting...</div>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; align-items:center;">
      <div class="file-preview mb-1" style="width:60px; height:60px; display:flex; justify-content:center; align-items:center; font-size:2rem; border-radius:6px; border:1px solid var(--bs-info); overflow:hidden;"></div>
      ${index > 0 ? `<button type="button" class="btn btn-sm btn-outline-danger removeFileBtn">Remove</button>` : ""}
    </div>
  `;
  
  fileContainer.appendChild(div);

  const fileInput = div.querySelector(".file-input");
  const noteInput = div.querySelector(".file-note");
  const preview = div.querySelector(".file-preview");
  const removeBtn = div.querySelector(".removeFileBtn");

  // File selected
  fileInput.addEventListener("change", e => {
    const file = e.target.files[0] || null;
    filesArray[index].file = file;

    if (!file) {
      preview.innerHTML = "";
      return;
    }

    if (file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = ev => {
        preview.innerHTML = `<img src="${ev.target.result}" style="max-width:100%; max-height:100%;">`;
      };
      reader.readAsDataURL(file);
    } else {
      preview.innerHTML = `<span>${getFileIcon(file.name)}</span>`;
    }

    updateUploadButton();
  });

  // Note input
  noteInput.addEventListener("input", e => {
    filesArray[index].note = e.target.value;
  });

  // Remove button
  if (removeBtn) {
    removeBtn.addEventListener("click", () => removeFileInput(index));
  }

  if (filesArray.length >= maxFiles) addFileBtn.style.display = "none";
}

// Remove a file input slot
function removeFileInput(index) {
  filesArray.splice(index, 1);
  const divToRemove = fileContainer.children[index];
  if (divToRemove) divToRemove.remove();

  Array.from(fileContainer.children).forEach((div, idx) => {
    div.querySelector(".file-input").dataset.index = idx;
    div.querySelector(".file-note").dataset.index = idx;
    div.querySelector("label").textContent = `File ${idx + 1}`;
    const removeBtn = div.querySelector(".removeFileBtn");
    if (removeBtn) removeBtn.onclick = () => removeFileInput(idx);
  });

  if (filesArray.length < maxFiles) {
    addFileBtn.style.display = "inline-block";
    addFileBtn.style.opacity = 1;
  }

  updateUploadButton();
}

// Disable the whole upload section
function disableUploadForm() {
  const formEls = document.querySelectorAll("#fileContainer input, #fileContainer button, #addFileBtn, #uploadBtn");
  formEls.forEach(el => el.disabled = true);
}

// Add File button click
addFileBtn.addEventListener("click", () => addFileInput());

// Upload files (with single persistent alert)
uploadBtn.addEventListener("click", async () => {
  alertsContainer.innerHTML = ""; // clear old alerts

  if (!filesArray.length || !filesArray.some(f => f.file)) {
    alertsContainer.innerHTML = `
      <div class="alert alert-info bg-info text-black alert-dismissible fade show" role="alert">
        Please add at least one file before uploading.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    return;
  }

  toggleLoader(true);
  const clientID = params.get("clientID") || "";
  let anyFailed = false;

  for (let i = 0; i < filesArray.length; i++) {
    const { file, note } = filesArray[i];
    if (!file) continue;

    const progressBar = fileContainer.children[i].querySelector(".progress-bar");
    progressBar.style.width = "0%";
    progressBar.textContent = "Uploading...";

    let progress = 0;
    const interval = setInterval(() => {
      progress = Math.min(progress + 5, 95);
      progressBar.style.width = progress + "%";
    }, 100);

    try {
      const reader = new FileReader();
      await new Promise((resolve, reject) => {
        reader.onload = async e => {
          clearInterval(interval);
          progressBar.style.width = "95%";

          const base64Data = e.target.result.split(',')[1];
          const payload = {
            system: "clientUploads",
            action: "uploadFile",
            clientID,
            firstName,
            lastName,
            email,
            fileName: file.name,
            fileData: base64Data,
            fileNote: note
          };

          const res = await fetch(scriptURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          let result;
          try { result = await res.json(); } 
          catch { result = { success: false, message: "Invalid JSON from server" }; }

          if (result.success) {
            progressBar.classList.add("bg-success");
            progressBar.style.width = "100%";
            progressBar.textContent = "File Uploaded ✓";
          } else {
            anyFailed = true;
            progressBar.classList.add("bg-danger");
            progressBar.style.width = "100%";
            progressBar.textContent = "Failed ❌";
          }
          resolve();
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    } catch (err) {
      clearInterval(interval);
      anyFailed = true;
      progressBar.classList.add("bg-danger");
      progressBar.style.width = "100%";
      progressBar.textContent = "Error ❌";
    }
  }

  toggleLoader(false);

  // Final alert (persistent)
  alertsContainer.innerHTML = `
    <div class="alert ${anyFailed ? "alert-danger" : "alert-info"} ${anyFailed ? "text-light" : "bg-info text-dark"}" role="alert">
      ${anyFailed 
        ? "Some files failed to upload. Please check and try again."
        : "All files have been successfully uploaded!"}
    </div>
  `;

  if (!anyFailed) {
    disableUploadForm(); // ✅ lock everything if successful
  }
});

// Initialize with 1 file input
addFileInput();

// Apply theme after DOM is ready
window.addEventListener('DOMContentLoaded', () => {
  const theme = localStorage.getItem('selectedTheme');
  if (theme) document.body.classList.add(theme);
});
</script>

</body>
</html>
