<!DOCTYPE html>
<html>
<head>
  <title>Email Manager</title>
</head>
<style>
  #emailBody {
    height: 200px;
  }
</style>
<body class="theme-dark p-4">
<div class="watermark"></div>
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>
<div id="loadingOverlay" class="d-none">
  <div class="text-center">
    <div class="spinner-border" role="status"></div>
    <p class="mt-4">Loading... Please wait...</p>
  </div>
</div>

  <div class="container">
    <h2 class="mb-4">📧 Email Template Manager</h2>

    <div class="mb-3">
      <label for="emailTypeSelect" class="form-label">Select Email Type</label>
      <select id="emailTypeSelect" class="form-select" onchange="loadTemplate(this.value)">
        <option value="">-- Choose Email Type --</option>
        <!-- Populated by JS -->
      </select>
    </div>

    <form id="templateForm" onsubmit="saveTemplate(event)">
      <div class="mb-3">
        <label for="emailSubject" class="form-label">Subject</label>
        <input type="text" class="form-control" id="emailSubject" required>
      </div>

      <div class="mb-3">
        <label for="emailBody" class="form-label">Body</label>
        <textarea class="form-control" id="emailBody" required></textarea>
      </div>

      <button type="submit" class="btn btn-primary">💾 Save Template</button>
      <span id="saveStatus" class="ms-3 text-success d-none">Saved!</span>
    </form>
  </div>

  <!-- Placeholder Legend Accordion (Table Style) -->
  <div class="container mt-4">
    <div class="accordion" id="placeholderLegendAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="legendHeading">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#legendCollapse" aria-expanded="false" aria-controls="legendCollapse">
            📋 Placeholder Legend - [ Click here to see some placeholders you can add ]
          </button>
        </h2>
        <div id="legendCollapse" class="accordion-collapse collapse" aria-labelledby="legendHeading" data-bs-parent="#placeholderLegendAccordion">
          <div class="accordion-body">
            <p>Click the 📋 button to copy a placeholder: (I can add more to this list upon demand)</p>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Placeholder</th>
                    <th>Description</th>
                    <th>Copy</th>
                  </tr>
                </thead>
                <tbody id="placeholderTableBody">
                  <tr>
                    <td><code>{{clientID}}</code></td>
                    <td>Client's Phone number</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{clientID}}')">📋</button></td>
                  </tr>
                   <tr>
                    <td><code>{{firstName}}</code></td>
                    <td>Client's first name</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{firstName}}')">📋</button></td>
                  </tr>
                  <tr>
                    <td><code>{{lastName}}</code></td>
                    <td>Client's last name</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{lastName}}')">📋</button></td>
                  </tr>
                  <tr>
                    <td><code>{{nickName}}</code></td>
                    <td>Client's nickname</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{nickName}}')">📋</button></td>
                  </tr>
                  <tr>
                    <td><code>{{email}}</code></td>
                    <td>Client's email address</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{email}}')">📋</button></td>
                  </tr>
                  <tr>
                  <tr>
                    <td><code>{{street}}</code></td>
                    <td>Client's Street</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{clientID}}')">📋</button></td>
                  </tr>
                  <tr>
                    <td><code>{{city}}</code></td>
                    <td>Client's City</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{clientID}}')">📋</button></td>
                  </tr>
                  <tr>
                    <td><code>{{state}}</code></td>
                    <td>Client's State</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{clientID}}')">📋</button></td>
                  </tr>
                  <tr>
                    <td><code>{{zip}}</code></td>
                    <td>Client's Zip</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{clientID}}')">📋</button></td>
                  </tr>
                  <tr>
                    <td><code>{{tier}}</code></td>
                    <td>Client's tier</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{tier}}')">📋</button></td>
                  </tr>
                    <td><code>{{uploadLink}}</code></td>
                    <td>Upload URL</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="copyPlaceholder('{{uploadLink}}')">📋</button></td>
                  </tr>
                  <!-- You can append more placeholders here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module" src="global.js"></script>
<!-- <script type="module" src="client.js"></script> -->
<script type="module" src="admin.js"></script>

<script>
let templates = {};

async function loadEmailTypes() {
  toggleLoader(true);
  try {
    const res = await fetch(scriptURL + "?action=getEmailTemplates");
    const data = await res.json();
    if (!Array.isArray(data)) {
      showToast("❌ Failed to load templates", "error");
      return;
    }

    templates = {};
    const select = document.getElementById('emailTypeSelect');
    select.innerHTML = '<option value="">-- Choose Email Type --</option>';
    data.forEach(t => {
      templates[t.type] = { subject: t.subject, body: t.body };
      const opt = document.createElement('option');
      opt.value = t.type;
      opt.textContent = t.type.charAt(0).toUpperCase() + t.type.slice(1);
      select.appendChild(opt);
    });

    // showToast("✅ Templates loaded", "success");
  } catch (err) {
    console.error(err);
    showToast("❌ Error loading templates", "error");
  } finally {
    toggleLoader(false);
  }
}

function loadTemplate(type) {
  if (!type || !templates[type]) return;
  document.getElementById('emailSubject').value = templates[type].subject;
  document.getElementById('emailBody').value = templates[type].body;
}

async function saveTemplate(e) {
  e.preventDefault();
  const type = document.getElementById('emailTypeSelect').value;
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;

  if (!type) {
    showToast("⚠️ Please select a template type", "warning");
    return;
  }

  const payload = {
    system: "email",
    action: "updateTemplate",
    type,
    subject,
    body
  };

  toggleLoader(true);
  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    });

    const json = await res.json();
    if (json.success) {
      document.getElementById('saveStatus').classList.remove('d-none');
      setTimeout(() => document.getElementById('saveStatus').classList.add('d-none'), 2000);
      templates[type] = { subject, body };
      showToast("✅ Template saved", "success");
    } else {
      showToast(`❌ Error saving template: ${json.message || "Unknown error"}`, "error");
    }
  } catch (err) {
    console.error(err);
    showToast("❌ Failed to save template", "error");
  } finally {
    toggleLoader(false);
  }
}

window.onload = loadEmailTypes;

// Simple copy-to-clipboard helper
function copyPlaceholder(text) {
  navigator.clipboard.writeText(text)
    .then(() => showToast(`Copied ${text}`, "success"))
    .catch(() => showToast(`Failed to copy`, "error"));
}

</script>

</body>
</html>
