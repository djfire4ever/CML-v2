<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CML Dashboard</title>
</head>

<style>
body.bg-black .btn-outline-primary { color: #0d6efd; border-color: #0d6efd; }
body.bg-black .btn-outline-info    { color: #0dcaf0; border-color: #0dcaf0; }
body.bg-black .btn-outline-danger  { color: #dc3545; border-color: #dc3545; }
body.bg-black .btn-outline-warning { color: #ffc107; border-color: #ffc107; }
body.bg-black .btn-outline-success { color: #198754; border-color: #198754; }

/* General button effect for stats, tiers, quick links, anniversaries, birthdays */
body.bg-black .btn {
  transition: all 0.3s ease;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Hover and active states for all outline buttons */
body.bg-black .btn-outline-primary:hover,
body.bg-black .btn-outline-info:hover,
body.bg-black .btn-outline-danger:hover,
body.bg-black .btn-outline-warning:hover,
body.bg-black .btn-outline-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 10px currentColor; /* glow using button color */
  z-index: 1;
}

body.bg-black .btn-outline-primary:active,
body.bg-black .btn-outline-info:active,
body.bg-black .btn-outline-danger:active,
body.bg-black .btn-outline-warning:active,
body.bg-black .btn-outline-success:active {
  transform: scale(0.98);
  box-shadow: none;
}

/* Optional: low-stock specific style if still needed */
.low-stock-row {  transition: all 0.3s ease;  border: none;}
.low-stock-row:hover {  transform: translateY(-2px);  box-shadow: 0 0 10px rgba(255, 193, 7, 0.3); /* Soft amber/yellow glow */  z-index: 1;}
.low-stock-row:active {  transform: scale(0.98);  box-shadow: none;}

/* Upload row selected style */
.upload-row.selected {  background-color: var(--bs-info) !important;  color: var(--bs-black) !important;  font-weight: bold;  border-left: 4px solid var(--bs-black);}

/* Tooltip styling */
.tooltip-inner {  font-size: 1.1rem;   font-weight: bold;  background-color: var(--bs-black) !important;}
.tooltip-supplier {  color: var(--bs-info); }
.tooltip-no-supplier {  color: var(--bs-danger); }

/* --- Dashboard Live/Cached Status Dot --- */
.status-dot {  display: inline-block;  width: 10px;  height: 10px;  border-radius: 50%;  margin-left: 6px;  background-color: orange; transition: transform 0.3s ease, opacity 0.3s ease;}
/* Optional: subtle bounce/fade animation when status changes */
.status-dot.update-live {  animation: dot-pop 0.4s ease forwards;}
@keyframes dot-pop {  0% { transform: scale(0.5); opacity: 0.5; }  50% { transform: scale(1.2); opacity: 1; }  100% { transform: scale(1); opacity: 1; }}
/* Tooltip styling (optional if using Bootstrap, otherwise custom) */
.status-dot[title] {  position: relative;}
.status-dot[title]:hover::after { content: attr(title);  position: absolute;  top: -25px;  left: 50%;  transform: translateX(-50%);  background: #000;  color: #fff;  font-size: 0.75rem;  padding: 2px 6px;  border-radius: 4px;  white-space: nowrap;  z-index: 1000;}

</style>

<body class="d-flex flex-column bg-black mt-3">
<div class="watermark"></div>
<div id="loadingOverlay" class="d-none">
  <div class="text-center text-info">
      <div class="spinner-border text-info" role="status"></div>
      <p class="mt-2">Loading dashboard data‚Ä¶</p>
  </div>
</div>
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

<div class="container">
  <h2 class="text-center text-info">Welcome to Your Dashboard Sunshine</h2>
    <h5 class="text-center text-info">
      <!-- <a href="test5.html" class="text-info text-decoration-none"> -->
        We might want to start adding some dates for the Anniversaries & Birthdays section soon.
      </a>
    </h5>

<button type="button" class="btn btn-sm btn-outline-info btn-end" data-bs-toggle="modal" data-bs-target="#cacheStatusModal">View Cache Status</button>

<!-- Modal -->
  <div class="modal fade" id="cacheStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Dashboard Cache Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="cacheStatusBody">
          <!-- Status will be populated here -->
        </div>
      </div>
    </div>
  </div>

<!-- Row 1 -->
<!-- Quick Links Accordion -->
<div class="row g-2 my-1">
  <div class="col-md-4 col-lg-4 my-1">
    <div class="accordion fade-in-card" id="quickLinksAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingQuickLinks">
          <button class="accordion-button bg-black text-info d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuickLinks" aria-expanded="true" aria-controls="collapseQuickLinks">
            <span><i class="fa-solid fa-link me-2"></i>Quick Links to Add</span>
          </button>
        </h2>
      <div id="collapseQuickLinks" class="accordion-collapse show" aria-labelledby="headingQuickLinks" data-bs-parent="#quickLinksAccordion">
        <div class="accordion-body bg-black text-light border-info">
          <div class="row g-2">
          <!-- Link 1 - Add Clients -->
            <div class="col-12">
              <button class="btn btn-outline-primary w-100 d-flex justify-content-between align-items-center" data-link="clientmanager.html#tab-add">
                <span>Add Clients</span><i class="fa-solid fa-user-plus"></i>
              </button>
            </div>
          <!-- Link 2 - Add Material -->
            <div class="col-12">
              <button class="btn btn-outline-info w-100 d-flex justify-content-between align-items-center" data-link="materialmanager.html#add-material">
                <span>Add Material</span><i class="fa-solid fa-cubes"></i>
              </button>
            </div>
          <!-- Link 3 - Add Product -->
            <div class="col-12">
              <button class="btn btn-outline-danger w-100 d-flex justify-content-between align-items-center" data-link="productmanager.html#add-product">
                <span>Add Product</span><i class="fa-solid fa-tags"></i>
              </button>
            </div>
          <!-- Link 4 - Add Quote -->
            <div class="col-12">
              <button class="btn btn-outline-warning w-100 d-flex justify-content-between align-items-center" data-link="quotemanager.html#add-quote">
                <span>Add Quote</span><i class="fa-solid fa-file-signature"></i>
              </button>
            </div>
          <!-- Link 5 - Add Inventory Disabled -->
            <div class="col-12">
              <button class="btn btn-outline-success w-100 d-flex justify-content-between align-items-center" data-link="materialmanager.html#add-inventory">
                <span>Add Inventory</span><i class="fa-solid fa-boxes-stacked"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- All Stats Accordion -->
  <div class="col-md-4 col-lg-4 my-1">
    <div class="accordion fade-in-card" id="statsAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingStats">
          <button class="accordion-button bg-black text-info " type="button" data-bs-toggle="collapse" data-bs-target="#collapseStats" aria-expanded="true" aria-controls="collapseStats">
            <i class="fa-solid fa-chart-line me-2"></i>All Stats
          </button>
        </h2>
        <div id="collapseStats" class="accordion-collapse show" aria-labelledby="headingStats">
          <div class="accordion-body bg-black text-light border-info">
            <div class="row g-2">
              <div class="col-12">
                <button class="btn btn-outline-primary w-100 d-flex justify-content-between align-items-center" data-link="clientmanager.html#tab-search">
                  <span>Total Clients:</span>
                  <span>
                    <span id="totalClients" class="fw-bold">--</span>
                    <span id="status-totalClients" class="status-dot"></span>
                  </span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-info w-100 d-flex justify-content-between align-items-center" data-link="materialmanager.html#search-material">
                  <span>Total Materials:</span>
                  <span>
                    <span id="totalMaterials" class="fw-bold">--</span>
                    <span id="status-totalMaterials" class="status-dot"></span>
                  </span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-danger w-100 d-flex justify-content-between align-items-center" data-link="productmanager.html#search-product">
                  <span>Total Products:</span>
                  <span>
                    <span id="totalProducts" class="fw-bold">--</span>
                    <span id="status-totalProducts" class="status-dot"></span>
                  </span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-warning w-100 d-flex justify-content-between align-items-center" data-link="quotemanager.html#search-quote">
                  <span>Total Quotes:</span>
                  <span>
                    <span id="totalQuotes" class="fw-bold">--</span>
                    <span id="status-totalQuotes" class="status-dot"></span>
                  </span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-success w-100 d-flex justify-content-between align-items-center" data-link="invoicemanager.html#search-invoice">
                  <span>Total Unpaid Invoices:</span>
                  <span>
                    <span id="unpaidInvoiceCount" class="fw-bold">--</span>
                    <span id="status-unpaidInvoiceCount" class="status-dot"></span>
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leads Accordion -->
  <div class="col-md-4 col-lg-4 mt-1">
    <div class="accordion fade-in-card" id="leadsAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingLeads">
          <button class="accordion-button bg-black text-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLeads" aria-expanded="true" aria-controls="collapseLeads">
            <i class="fa-solid fa-address-card me-2"></i>Leads Overview
          </button>
        </h2>
        <div id="collapseLeads" class="accordion-collapse show" aria-labelledby="headingLeads">
          <div class="accordion-body bg-black text-light border-info">
            <div class="row g-2">
              <div class="col-12">
                <button class="btn btn-outline-primary w-100 d-flex justify-content-between align-items-center">
                  <span>New Leads:</span>
                  <span>
                    <span id="newLeads" class="fw-bold">0</span>
                    <span id="status-newLeads" class="status-dot"></span>
                  </span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-info w-100 d-flex justify-content-between align-items-center">
                  <span>Follow-Up Leads:</span>
                  <span>
                    <span id="followupLeads" class="fw-bold">0</span>
                    <span id="status-followupLeads" class="status-dot"></span>
                  </span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-danger w-100 d-flex justify-content-between align-items-center">
                  <span>Pending Leads:</span>
                  <span>
                    <span id="pendingLeads" class="fw-bold">0</span>
                    <span id="status-pendingLeads" class="status-dot"></span>
                  </span>
                </button>
              </div>
            </div>
            <div class="d-grid mt-3">
              <button class="btn btn-outline-warning" data-link="leads.html">View Leads</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Row 2 -->
<div class="row g-2 my-1">
  <!-- Anniversaries & Birthdays Accordion -->
  <div class="col-md-4 col-lg-4 my-1">
    <div class="accordion fade-in-card" id="anniversariesAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingAnniversaries">
          <button class="accordion-button bg-black text-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnniversaries" aria-expanded="true" aria-controls="collapseAnniversaries">
            üéâ Anniversaries & Birthdays
            <span id="anniversaryCountBadge" class="badge bg-info text-black rounded-pill ms-auto">0</span>
          </button>
        </h2>
        <div id="collapseAnniversaries" class="accordion-collapse show" aria-labelledby="headingAnniversaries">
          <div class="accordion-body bg-black text-info border-info">
            <ul id="anniversariesList" class="list-group list-group">
              <!-- JS will populate <li><button>‚Ä¶</button></li> rows here dynamically -->
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üìÖ Calendar Events Today Accordion -->
  <div class="col-md-4 col-lg-4 my-1">
    <div class="accordion fade-in-card" id="calendarTodayAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingToday">
          <button class="accordion-button bg-black text-info" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapseToday"
                  aria-expanded="true" aria-controls="collapseToday">
            <i class="fa-solid fa-calendar-day me-2"></i>Today's Events
            <span id="todayEventCount" class="badge bg-info text-black rounded-pill ms-auto">0</span>
          </button>
        </h2>
        <div id="collapseToday" class="accordion-collapse show" aria-labelledby="headingToday"
            data-bs-parent="#calendarTodayAccordion">
          <div class="accordion-body bg-black text-info p-2" style="max-height: 300px; overflow-y: auto;">
            <ul class="list-group list-group-flush" id="todayEventList"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üìÜ Calendar Events This Week Accordion -->
  <div class="col-md-4 col-lg-4 my-1">
    <div class="accordion fade-in-card" id="calendarWeekAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingWeekEvents">
          <button class="accordion-button bg-black text-info" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapseWeekEvents"
                  aria-expanded="true" aria-controls="collapseWeekEvents">
            <i class="fa-solid fa-calendar-week me-2"></i>This Week's Events
            <span id="weekEventCount" class="badge bg-info text-black rounded-pill ms-auto">0</span>
          </button>
        </h2>
        <div id="collapseWeekEvents" class="accordion-collapse show" aria-labelledby="headingWeekEvents">
          <div class="accordion-body bg-black text-info p-2" style="max-height: 300px; overflow-y: auto;">
            <div id="weekEventsGroup"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Row 3 -->
<div class="row g-2 my-1">
  <!-- Low-Stock Accordion -->
  <div class="col-md-4 col-lg-4 my-1">
    <div class="accordion fade-in-card" id="lowStockAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingLowStock">
          <button class="accordion-button bg-black text-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLowStock" aria-expanded="true" aria-controls="collapseLowStock">
            <i class="fa-solid fa-boxes-stacked me-2"></i>Low Stock-Order<span id="lowStockCount" class="badge bg-info text-black rounded-pill ms-auto">0</span>
          </button>
        </h2>
        <div id="collapseLowStock" class="accordion-collapse collapse" aria-labelledby="headingLowStock" data-bs-parent="#lowStockAccordion">
          <div class="accordion-body bg-black text-light p-0" style="max-height: 300px; overflow-y: auto;">
            <ul class="list-group list-group-flush" id="lowStockList"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Uploads Accordion -->
  <div class="col-md-4 col-lg-4 my-1">
    <div class="accordion fade-in-card" id="recentUploadsAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingUploads">
          <button class="accordion-button bg-black text-info" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapseUploads"
                  aria-expanded="true" aria-controls="collapseUploads">
            <i class="fa-solid fa-upload me-2"></i>Recent Uploads
            <span id="recentUploadCountBadge" class="badge bg-info text-black rounded-pill ms-auto">0</span>
          </button>
        </h2>
        <div id="collapseUploads" class="accordion-collapse collapse" aria-labelledby="headingUploads">
          <div class="accordion-body bg-black text-info p-2" style="max-height: 300px; overflow-y: auto;">
            <ul class="list-group list-group-flush" id="recentUploadsList"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tier Levels Accordion -->
  <div class="col-md-4 col-lg-4 my-1">
    <div class="accordion fade-in-card" id="tiersAccordion">
      <div class="accordion-item border-info">
        <h2 class="accordion-header" id="headingTiers">
          <button class="accordion-button bg-black text-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTiers" aria-expanded="true" aria-controls="collapseTiers">
            <i class="fa-solid fa-medal me-2"></i>Tier Levels
          </button>
        </h2>
        <div id="collapseTiers" class="accordion-collapse collapse" aria-labelledby="headingTiers">
          <div class="accordion-body bg-black text-light border-info">
            <div class="row g-2">
              <div class="col-12">
                <button class="btn btn-outline-info w-100 d-flex justify-content-between align-items-center tier-btn" data-tier="New">
                  <span class="text-info">üÜï New ‚Ä¢</span><span id="tierNew" class="fw-bold text-info">--</span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center tier-btn" data-tier="Silver">
                  <span class="text-secondary">ü•à Silver ‚Ä¢</span><span id="tierSilver" class="fw-bold text-info">--</span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-warning w-100 d-flex justify-content-between align-items-center tier-btn" data-tier="Gold">
                  <span class="text-warning">ü•á Gold ‚Ä¢</span><span id="tierGold" class="fw-bold text-warning">--</span>
                </button>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-danger w-100 d-flex justify-content-between align-items-center tier-btn" data-tier="Platinum">
                  <span class="text-danger">üíé Platinum ‚Ä¢</span><span id="tierPlatinum" class="fw-bold text-danger">--</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Upload Details Modal -->
  <div class="modal fade" id="uploadDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-black text-info">
        <div class="modal-header">
          <h5 class="modal-title">Upload Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="uploadDetailsContent" style="overflow-y:auto; max-height:500px;"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="deleteUploadBtn">Delete File</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<script type="module" src="global.js"></script>
<script type="module" src="admin.js"></script>

<script>
function populateCacheStatusModal(data) {
  const modalBody = document.getElementById("cacheStatusBody");
  if (!modalBody || !data.dashboardStatus || !data.cacheTimestamps) return;

  modalBody.innerHTML = ""; // clear previous content
  const list = document.createElement("ul");
  list.className = "list-group list-group-flush";

  Object.keys(data.dashboardStatus).forEach(section => {
    const li = document.createElement("li");
    li.className = "list-group-item bg-dark text-info d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <span>${section}</span>
      <span>[${data.dashboardStatus[section]}] ‚Ä¢ ${new Date(data.cacheTimestamps[section]).toLocaleString()}</span>
    `;
    list.appendChild(li);
  });

  modalBody.appendChild(list);
}

document.addEventListener("DOMContentLoaded", () => {
  const modalEl = document.getElementById("cacheStatusModal");
  if (!modalEl) return;

  modalEl.addEventListener("show.bs.modal", () => {
    const body = document.getElementById("cacheStatusBody");
    if (!body) return;

    const dashboardData = window._dashboardData || {}; // whatever your dashboard fetch sets
    const status = dashboardData.dashboardStatus || {};
    const timestamps = dashboardData.cacheTimestamps || {};

    body.innerHTML = Object.keys(status).map(key => {
      const stat = status[key];
      const ts = timestamps[key] ? new Date(timestamps[key]).toLocaleString() : "-";
      return `<div><strong>${key}</strong>: [${stat}] ‚Ä¢ ${ts}</div>`;
    }).join("");
  });
});

// ===== Dashboard Fetch with Configurable Upcoming Window =====
// const UPCOMING_WINDOW_DAYS = 30 ; // üëà change this to adjust range for anniversaries/birthdays

// ==============================
// Fetch Dashboard Stats
// ==============================
async function fetchDashboardStats() {
  try {
    const response = await fetch(`${scriptURL}?action=getDashboardData`);
    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

    const data = await response.json();
    window._dashboardData = data;
    const now = new Date();

    // --- ‚úÖ Populate modal with cache/live status ---
    const cacheStatusBody = document.getElementById("cacheStatusBody");
    if (cacheStatusBody && data.dashboardStatus && data.cacheTimestamps) {
      cacheStatusBody.innerHTML = ""; // clear old content
      Object.keys(data.dashboardStatus).forEach(section => {
        const div = document.createElement("div");
        div.className = "d-flex justify-content-between align-items-center mb-1 p-1 bg-dark text-info rounded";
        div.innerHTML = `
          <span>${section}</span>
          <span>[${data.dashboardStatus[section]}] ‚Ä¢ ${new Date(data.cacheTimestamps[section]).toLocaleString()}</span>
        `;
        cacheStatusBody.appendChild(div);
      });
    }

    // --- ‚úÖ Update top-level counts ---
    document.getElementById("totalClients").textContent = data.clients?.data ?? data.clients ?? 0;
    document.getElementById("totalProducts").textContent = data.products ?? 0;
    document.getElementById("totalMaterials").textContent = data.materials ?? 0;
    document.getElementById("unpaidInvoiceCount").textContent = data.unpaidInvoices ?? 0;
    document.getElementById("totalQuotes").textContent = data.quotes ?? 0;

    // --- ‚úÖ Tier counts ---
    const tiers = data.tiers?.data || data.tiers;
    if (tiers) {
      document.getElementById("tierNew").textContent = tiers.New ?? 0;
      document.getElementById("tierSilver").textContent = tiers.Silver ?? 0;
      document.getElementById("tierGold").textContent = tiers.Gold ?? 0;
      document.getElementById("tierPlatinum").textContent = tiers.Platinum ?? 0;
    }

    // --- ‚úÖ Leads Overview ---
    const leads = data.leads?.data || data.leads;
    if (leads) {
      const elNew = document.getElementById("newLeads");
      const elFollow = document.getElementById("followupLeads");
      const elPending = document.getElementById("pendingLeads");
      if (elNew) elNew.textContent = leads.new ?? 0;
      if (elFollow) elFollow.textContent = leads.followUp ?? 0;
      if (elPending) elPending.textContent = leads.pending ?? 0;

      // üîî Update lead notification badge (if iframe parent exists)
      const parentDoc = window.parent?.document;
      if (parentDoc) {
        const badge = parentDoc.getElementById("leadNotifBadge");
        const bell = parentDoc.getElementById("leadNotifBtn");
        const bellIcon = bell?.querySelector("i");
        if (badge && bell) {
          const totalLeads = (leads.new || 0) + (leads.followUp || 0) + (leads.pending || 0);
          if (totalLeads > 0) {
            badge.textContent = totalLeads;
            badge.classList.remove("d-none");
            bell.setAttribute("title", `${totalLeads} lead${totalLeads === 1 ? "" : "s"} need attention`);
            bellIcon?.classList.add("ringing");
          } else {
            badge.textContent = "";
            badge.classList.add("d-none");
            bell.setAttribute("title", "No new leads");
            bellIcon?.classList.remove("ringing");
          }
        }
      }
    }

    // --- ‚úÖ Low stock ---
    const lowStockList = document.getElementById("lowStockList");
    if (lowStockList) {
      lowStockList.innerHTML = "";
      const lowStockData = Array.isArray(data.lowStock?.data) ? data.lowStock.data : (Array.isArray(data.lowStock) ? data.lowStock : []);
      document.getElementById("lowStockCount").textContent = lowStockData.length ?? 0;

      if (lowStockData.length) {
        lowStockData.forEach(item => {
          const li = document.createElement("li");
          li.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center text-info bg-black low-stock-row";
          li.style.cursor = "pointer";
          li.innerHTML = `
            <div class="w-75 text-start">${item.matName}</div>
            <div class="w-25 text-end">${item.onHand}</div>
          `;
          li.setAttribute("data-bs-toggle", "tooltip");
          li.setAttribute("data-bs-html", "true");
          li.setAttribute("title", item.supplierUrl
            ? `Click to order from <span class="tooltip-supplier">${item.supplier || "supplier"}</span>`
            : `<span class="tooltip-no-supplier">No supplier listed</span>`);
          li.addEventListener("click", () => { if (item.supplierUrl) window.open(item.supplierUrl, "_blank"); });
          lowStockList.appendChild(li);
        });
        lowStockList.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(t => new bootstrap.Tooltip(t));
      } else {
        lowStockList.innerHTML = `<li class="list-group-item bg-black text-info">‚úÖ All stock levels healthy.</li>`;
      }
    }

    // --- ‚úÖ Upcoming anniversaries & birthdays ---
    const anniversariesList = document.getElementById("anniversariesList");
    const anniversaryCountBadge = document.getElementById("anniversaryCountBadge");
    if (anniversariesList && anniversaryCountBadge) {
      anniversariesList.innerHTML = "";
      const eventsData = (data.events && data.events.data) || data.events || { anniversaries: [], birthdays: [] };
      const events = [];

      eventsData.anniversaries.forEach(a => {
        const d = new Date(a.date);
        if (!isNaN(d)) events.push({ type: "Anniversary", name: a.firstName, clientID: a.clientID, date: d, years: a.years, daysUntil: a.daysUntil });
      });
      eventsData.birthdays.forEach(b => {
        const d = new Date(b.date);
        if (!isNaN(d)) events.push({ type: "Birthday", name: b.firstName, clientID: b.clientID, date: d, daysUntil: b.daysUntil });
      });

      events.sort((a,b) => a.date - b.date);
      anniversaryCountBadge.textContent = events.length;

      if (!events.length) {
        anniversariesList.innerHTML = `<li class="list-group-item bg-black text-info">No upcoming events.</li>`;
      } else {
        events.forEach(e => {
          const li = document.createElement("li");
          li.className = "list-group-item bg-black p-0 border-0";
          const btnClass = e.type === "Anniversary" ? "btn-outline-info" : "btn-outline-warning";
          li.innerHTML = `
            <button class="btn ${btnClass} w-100 d-flex justify-content-between align-items-center text-start px-2 py-2">
              <span class="flex-grow-1 text-truncate">
                ${e.type === "Anniversary" ? `üéâ ${e.name} ‚Ä¢ ${e.years} year${e.years > 1 ? "s" : ""}` : `üéÇ ${e.name} ‚Ä¢ B-Day`}
              </span>
              <small class="ms-auto">
                ${e.daysUntil === 0 ? "Today!" : `in ${e.daysUntil} day${e.daysUntil > 1 ? "s" : ""}`}
              </small>
            </button>
          `;
          li.querySelector("button").onclick = () => {
            const iframe = window.parent.document.getElementById("content-frame");
            if (!iframe) return console.error("‚ùå iframe not found in parent");
            iframe.src = `clientmanager.html?focusClientID=${e.clientID}&emailType=${e.type}&tenure=${e.years || ""}`;
          };
          anniversariesList.appendChild(li);
        });
      }
    }

    // --- ‚úÖ Recent uploads ---
    if (Array.isArray(data.clientUploads?.data)) {
      const uploadsList = document.getElementById("recentUploadsList");
      if (uploadsList) {
        const filteredUploads = data.clientUploads.data
          .filter(u => !["DeletedByUser","Expired"].includes(u.fileStatus))
          .sort((a,b) => new Date(b.uploadDate || 0) - new Date(a.uploadDate || 0));

        window._recentUploads = filteredUploads;
        document.getElementById("recentUploadCountBadge").textContent = filteredUploads.length;

        const html = filteredUploads.length
          ? filteredUploads.map((u,i) => {
              const uploadDateStr = u.uploadDate ? new Date(u.uploadDate).toLocaleDateString() : "No date";
              const fileExtMatch = u.fileName?.match(/\.(\w+)$/);
              const fileExt = fileExtMatch ? fileExtMatch[1].toLowerCase() : "unknown";
              let typeLabel = "File";
              if (u.fileType?.startsWith("image/")) typeLabel = "Image";
              else if (u.fileType?.startsWith("text/")) typeLabel = "Document";
              else if (u.fileType === "application/pdf") typeLabel = "PDF";
              let statusIcon;
              switch ((u.fileStatus || "").toLowerCase()) {
                case "viewed": statusIcon = `<span class="upload-status text-success ms-2" title="Viewed">üëÅÔ∏è</span>`; break;
                case "active":
                case "new":
                default: statusIcon = `<span class="upload-status text-warning ms-2" title="New">üÜï</span>`;
              }
              return `
                <li class="list-group-item bg-black text-info upload-row" data-index="${i}" data-id="${u.uploadID}" style="cursor:pointer;">
                  <div class="d-flex justify-content-between">
                    <strong>${u.firstName || ""} ${u.lastName || ""}</strong>
                    <small class="text-info">${uploadDateStr}</small>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <small>${typeLabel} ‚Ä¢ ${fileExt}</small>
                    ${statusIcon}
                  </div>
                </li>`;
            }).join("")
          : `<li class="list-group-item bg-black text-info">No uploads available.</li>`;

        uploadsList.innerHTML = html;
        attachUploadRowEvents?.();
        populateCacheStatusModal(data);
      }
    }

  } catch (err) {
    console.error("Dashboard fetch error:", err);
  }
}

// ==============================
// 2Ô∏è‚É£ Attach Click Events to Upload Rows
// ==============================
function attachUploadRowEvents() {
  document.querySelectorAll(".upload-row").forEach((row, i) => {
    row.addEventListener("click", () => {
      const upload = window._recentUploads[i];
      if (!upload) return;

      // Highlight clicked row
      document.querySelectorAll(".upload-row").forEach(r => r.classList.remove("selected"));
      row.classList.add("selected");

      // Show modal
      showUploadModal(upload);

      // Mark as viewed (backend + UI)
      markUploadViewed(upload.uploadID);
    });
  });
}

// ==============================
// 3Ô∏è‚É£ Show Modal
// ==============================
function showUploadModal(upload) {
  const modalBody = document.getElementById("uploadDetailsContent");
  const deleteBtn = document.getElementById("deleteUploadBtn");
  const modalEl = document.getElementById("uploadDetailsModal");

  const status = (upload.fileStatus || "Active").toLowerCase();
  const statusBadge = status === "viewed"
    ? `<span class="badge bg-success">Viewed</span>`
    : `<span class="badge bg-warning text-black">New</span>`;

  modalBody.innerHTML = `
    <p><strong>Status: ${upload.fileStatus || "Unknown"}</strong> ${statusBadge}</p>
    <p><strong>Client:</strong> ${upload.firstName || ""} ${upload.lastName || ""}</p>
    <p><strong>File:</strong> <a href="${upload.url || '#'}" target="_blank">${upload.fileName || "Unknown"}</a></p>
    <p><strong>Date:</strong> ${upload.uploadDate ? new Date(upload.uploadDate).toLocaleString() : "Unknown"}</p>
    ${upload.fileNote ? `<p><strong>Note:</strong> ${upload.fileNote}</p>` : ""}
  `;

  if (deleteBtn) {
    deleteBtn.onclick = () => {
      // Toast content with inline Yes/Cancel buttons
      const toastContent = `
        Are you sure you want to delete this file?
        <button id="toastYes" class="btn btn-sm btn-success ms-2">Yes</button>
        <button id="toastCancel" class="btn btn-sm btn-secondary ms-1">Cancel</button>
      `;

      showToast(toastContent, { delay: 0, autohide: false, className: "bg-warning text-dark" });

      setTimeout(() => {
        const yesBtn = document.getElementById("toastYes");
        const cancelBtn = document.getElementById("toastCancel");

        if (yesBtn) {
          yesBtn.onclick = async () => {
            toggleLoader(true);

            try {
              const res = await fetch(scriptURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  system: "clientUploads",
                  action: "deleteUploadFile",
                  uploadID: upload.uploadID
                })
              });
              const result = await res.json();
              toggleLoader(false);

              if (result.success) {
                showToast("File deleted successfully.", "success");
                await fetchDashboardStats();
                const inst = bootstrap.Modal.getInstance(modalEl);
                if (inst) inst.hide();
              } else {
                showToast(result.message || "Failed to delete file.", "danger");
              }
            } catch (err) {
              toggleLoader(false);
              console.error(err);
              showToast("Error deleting file.", "danger");
            }
          };
        }

        if (cancelBtn) {
          cancelBtn.onclick = () => {
            const toastEl = cancelBtn.closest(".toast");
            if (toastEl) bootstrap.Toast.getOrCreateInstance(toastEl).hide();
          };
        }
      }, 50);
    };
  }

  const modal = new bootstrap.Modal(modalEl);
  modal.show();
}

// ==============================
// 4Ô∏è‚É£ Mark Upload as Viewed
// ==============================
async function markUploadViewed(uploadID) {
  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ system: "clientUploads", action: "markUploadViewed", uploadID })
    });
    const result = await res.json();
    if (!result.success) console.warn("Failed to mark upload as viewed:", result.message);

    // Update icon immediately in the row
    const rowEl = document.querySelector(`.upload-row[data-id="${uploadID}"]`);
    if (rowEl) {
      const iconEl = rowEl.querySelector(".upload-status");
      if (iconEl) {
        iconEl.textContent = "üëÅÔ∏è";
        iconEl.title = "Viewed";
        iconEl.classList.remove("text-warning");
        iconEl.classList.add("text-success");
      }
    }
  } catch (err) {
    console.error("Error marking upload as viewed:", err);
  }
}

// ‚úÖ Run after DOM is ready
document.addEventListener("DOMContentLoaded", () => {
  toggleLoader(true);
  fetchDashboardStats().finally(() => toggleLoader(false));
});

document.addEventListener('click', function (e) {
  var linkButton = e.target.closest('[data-link]');
  if (linkButton) {
    e.preventDefault(); // Prevent normal link jumping
    var link = linkButton.getAttribute('data-link');
    if (link && window.parent) {
      var iframe = window.parent.document.getElementById('content-frame'); // ‚úÖ YOUR iframe id
      if (iframe) {
        iframe.src = link;
      }
    }
  }
});

document.addEventListener("DOMContentLoaded", () => {

function formatTime(isoString) {
  const date = new Date(isoString);
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function loadCalendarSummaries() {
  const now = new Date();
  const startOfToday = new Date(now.setHours(0, 0, 0, 0)).toISOString();
  const endOfToday = new Date(now.setHours(23, 59, 59, 999)).toISOString();

  const startOfWeek = new Date();
  startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
  startOfWeek.setHours(0, 0, 0, 0);

  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(endOfWeek.getDate() + 6);
  endOfWeek.setHours(23, 59, 59, 999);

  fetch(scriptURL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      system: 'calendar',
      action: 'getEvents',
      start: startOfWeek.toISOString(),
      end: endOfWeek.toISOString()
    })
  })
  .then(res => res.json())
  .then(data => {
    const events = Array.isArray(data?.data) ? data.data : [];

    const todayList = document.getElementById("todayEventList");
    const weekGroup = document.getElementById("weekEventsGroup");
    const todayBadge = document.getElementById("todayEventCount");
    const weekBadge = document.getElementById("weekEventCount");

    if (!todayList || !weekGroup || !todayBadge || !weekBadge) {
      console.error("‚ùå One or more calendar summary elements are missing from the HTML.");
      return;
    }

    todayList.innerHTML = '';
    weekGroup.innerHTML = '';
    todayBadge.textContent = '0';
    weekBadge.textContent = '0';

    const grouped = {};
    let todayCount = 0;
    let weekCount = 0;

    events.forEach(ev => {
      const evDate = new Date(ev.start).toLocaleDateString();
      grouped[evDate] = grouped[evDate] || [];
      grouped[evDate].push(ev);
      weekCount++;

      // Today's events
      if (new Date(ev.start).toDateString() === new Date().toDateString()) {
        todayCount++;
        const li = document.createElement("li");
        li.className = "list-group-item bg-black text-light d-flex justify-content-between align-items-center";
        li.innerHTML = `<span>${ev.title}</span><span class="text-info">${formatTime(ev.start)}</span>`;
        todayList.appendChild(li);
      }
    });

    for (const [date, evs] of Object.entries(grouped)) {
      const dateGroup = document.createElement("div");
      dateGroup.className = "mb-2";
      dateGroup.innerHTML = `<div class="fw-bold text-info mb-1">${date}</div>`;

      evs.forEach(ev => {
        const eventLine = document.createElement("div");
        eventLine.className = "text-info small border-bottom border-info pb-1 mb-1";
        eventLine.innerHTML = `<span class="text-warning">${formatTime(ev.start)}</span> - ${ev.title}`;
        dateGroup.appendChild(eventLine);
      });

      weekGroup.appendChild(dateGroup);
    }

    // Update badge counts
    todayBadge.textContent = todayCount;
    weekBadge.textContent = weekCount;
  })
  .catch(err => {
    console.error("‚ùå Error loading calendar summary:", err);
  });
}
  loadCalendarSummaries();
});

document.addEventListener("DOMContentLoaded", () => {
  const tierButtons = document.querySelectorAll(".tier-btn");

  tierButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const tier = btn.dataset.tier; // "New", "Silver", "Gold", "Platinum"

      // --- Get the dashboard iframe ---
      const iframe = window.parent?.document?.getElementById("content-frame");
      if (!iframe) {
        console.error("‚ùå iframe not found in parent");
        return;
      }

      // --- Load clientmanager page with tier filter ---
      iframe.src = `clientmanager.html?tier=${encodeURIComponent(tier)}`;
    });
  });
});

document.querySelectorAll('.accordion-button').forEach(btn => {
  btn.addEventListener('click', () => {
    // Use a short delay to allow the collapse animation to start
    setTimeout(() => {
      btn.closest('.accordion-item')?.scrollIntoView({
        behavior: 'smooth',
        block: 'center' // or 'start' if you prefer it pinned to the top
      });
    }, 300); // 300ms matches Bootstrap‚Äôs default collapse animation speed
  });
});

// --- Attach lead type filters to dashboard buttons ---
function attachDashboardLeadFilters() {
  const leadButtons = [
    { id: "newLeads", filter: "new" },
    { id: "followupLeads", filter: "follow-up" },
    { id: "pendingLeads", filter: "pending" }
  ];

  leadButtons.forEach(({ id, filter }) => {
    const btn = document.getElementById(id)?.closest("button");
    if (!btn) return;

    btn.onclick = () => {
      // Navigate to leads.html with filter query param
      window.location.href = `leads.html?filter=${filter}`;
    };
  });

  // Optional: the "View Leads" button goes to full unfiltered page
  const viewAllBtn = document.querySelector('.accordion-body [data-link="leads.html"]');
  if (viewAllBtn) {
    viewAllBtn.onclick = () => {
      window.location.href = "leads.html";
    };
  }
}

// Call this after dashboard HTML is rendered
attachDashboardLeadFilters();

</script>
</body>
</html>
<!-- i did this to see if the live site updates -->